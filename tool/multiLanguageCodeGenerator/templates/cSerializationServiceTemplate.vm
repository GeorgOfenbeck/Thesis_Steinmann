\#include "sharedDOM/MultiLanguageSerializationService.h"
\#include "Exception.h"
\#include <typeinfo>
\#include <string>
\#include <cstdio>

#foreach($class in $classes)
\#include "${class.name}.h"
#end

using namespace std;


#macro(serializeNonList $field )
	#if ($field.typeDescriptor.reference)
		Serialize(value,output);
	#else
		output<<value<<"\n";
	#end
#end 

void MultiLanguageSerializationService::Serialize(MultiLanguageObjectBase *o, ostream &output){
	if (o==NULL){
		output<<"<null>\n";
		return;
	}
	
#foreach($class in $classes)
	if (o->getType()== MULTI_LANGUAGE_TYPE_ENUM_$class.name ){
		output << "$class.name" <<"\n";
		#foreach($field in $class.allFields)
			{
				output << "${field.name}\n";
				$field.cType value=((${class.name}*)o)->get${field.nameUpperCamel}();
				
				#if ($field.class.simpleName=="MultiLanguageList")
				{
					$field.cType list=value;
					unsigned size= list.size();
					output << size << "\n";
				
					for (unsigned i=0; i<size; i++){
						$field.getcItemType() value=list[i];
						#serializeNonList($field)
					}
				}
			
				#else
					#serializeNonList($field)
				#end
			}
		#end
		return;
	}
#end
	
	throw Exception((std::string)"Unknown class: "+typeid(o).name());
}

#macro(deSerializeNonList $field )
	#if ($field.type == "bool")
		int value;
	#else
		$field.getcItemType() value;
	#end
	
	
	#if ($field.typeDescriptor.reference)
		## deserialize references
		value=(${field.getcItemType()}) DeSerialize(input);
	#else
		getline(input,line);
		#if ($field.type == "string")
			value=line;
		#else
			if (sscanf(line.c_str(),"${field.typeDescriptor.scanfSpecification}",&value)!=1){
				throw Exception((std::string)"Parse Error: could not parse "+line+" as $field.type using scanf specification ${field.typeDescriptor.scanfSpecification}. "
				+ "Was parsing $field.name of $class.name");
			}
		#end
	#end
#end 
	
MultiLanguageObjectBase * MultiLanguageSerializationService::DeSerialize(istream &input){
	string line;
	
	if (input.eof()){
		throw Exception("deserializing: unexpected end of input");
	}
	
	if (!input.good()){
		throw Exception("deserializing: something's wrong with the input stream");
	}
	
	getline(input,line);
	
	if (line.compare("<null>")==0){
		return NULL;
	}

#foreach($class in $classes)		
	if (line.compare("$class.name")==0){
		$class.name *result=new ${class.name}();
		
		#foreach($field in $class.allFields)
		{
			getline(input,line);
			if (line.compare("${field.name}")!=0){
				throw Exception("Parse Error. Field $field.name of class $class.name expected. got "+line);
			}
			#if ($field.class.simpleName=="MultiLanguageList")
			{
				## read the line with the count
				getline(input,line);
				int count;
				if (sscanf(line.c_str(),"%i",&count)!=1){
					throw Exception("Parse Error. could not parse item count of list $field.name of $class.name. Item count string is "+line);
				}
				
				## parse all elements
				for (int i=0; i<count; i++){
					#deSerializeNonList($field)
					result->get${field.nameUpperCamel}().push_back(value);
				}
			}
			#else
				#deSerializeNonList($field)
				result->set${field.nameUpperCamel}(value);
			#end
		}
		#end

		return result;
	}
#end

	throw Exception("Parse Error: class "+line+" is not known");;
}
